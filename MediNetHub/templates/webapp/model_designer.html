{% extends 'base.html' %}
{% load webapp_filters %}

{% block title %}MediNet - Dissenyador de Models{% endblock %}

{% block extra_css %}
<style>
    .model-card {
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        width: 100%; /* Anchura fija para todas las tarjetas */
        max-width: 400px; /* Anchura m谩xima constante */
        min-width: 350px; /* Anchura m铆nima constante */
    }
    
    #layers-container.card-body { /* Target the specific card-body for layers */
        position: relative; /* Keep: Needed for absolute positioning of SVG container */
        overflow: visible; /* CANVIAT: Permet que les l铆nies de connexi贸 surtin del contenidor */
        min-height: 450px; /* Keep and adjust as needed, ensures some initial space */
    }
    
    .card-header {
        border-radius: 8px 8px 0 0;
        padding: 0.8rem 1rem;
    }
    
    .layer-box {
        position: relative;
        background-color: #e9f7f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #c7e6d7;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        max-width: 200px;
        margin: 0 auto;
    }
    
    .layer-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    }
    
    .input-layer {
        background-color: #e3f0ff;
        border: 1px solid #c0d8f3;
    }
    
    .output-layer {
        background-color: #ffe8e8;
        border: 1px solid #f5d1d1;
    }
    
    .linear-layer {
        background-color: #f8f8f8;
        border: 1px solid #e1e1e1;
    }

    .hidden-layer {
        background-color: #f8f8f8;
        border: 1px solid #e1e1e1;
    }
    
    .conv-layer {
        background-color: #e6e6fa;
        border: 1px solid #d8d8f3;
    }

    .norm-layer {
        background-color: #fff0f5;
        border: 1px solid #f3d8e3;
    }

    .pool-layer {
        background-color: #f0fff0;
        border: 1px solid #d8f3d8;
    }

    .dropout-layer {
        background-color: #fffacd;
        border: 1px solid #f3edb3;
    }

    .activation-layer {
        background-color: #ffdead;
        border: 1px solid #f3d8b3;
    }

    .flatten-layer {
        background-color: #e0ffff;
        border: 1px solid #b3f3f3;
    }

    .recurrent-layer {
        background-color: #dda0dd;
        border: 1px solid #d8b3f3;
    }
    
    .layer-connector {
        height: 30px;
        border-left: 2px dashed #aaa;
        margin: 0 auto;
        width: 2px;
    }
    
    .layer-features {
        font-size: 0.85rem;
        color: #666;
        margin-top: 5px;
    }
    
    .hand-pointer {
        font-size: 48px;
        color: #888;
        margin-bottom: 10px;
    }
    
    .btn-add-layer {
        border-radius: 50px;
    }
    
    .param-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #888;
        text-align: center;
        padding: 2rem;
    }

    .notification-banner {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        min-width: 300px;
        max-width: 600px;
        animation: slideIn 0.3s ease-out;
        font-weight: 500;
    }

    .notification-success {
        background-color: #28a745;
        color: white;
    }

    .notification-warning {
        background-color: #ffc107;
        color: #000;
        border-left: 4px solid #ff9800;
    }

    .notification-error {
        background-color: #dc3545;
        color: white;
        border-left: 4px solid #c82333;
    }

    .notification-info {
        background-color: #17a2b8;
        color: white;
        border-left: 4px solid #138496;
    }

    @keyframes slideIn {
        from {
            transform: translate(-50%, -100%);
            opacity: 0;
        }
        to {
            transform: translate(-50%, 0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translate(-50%, 0);
            opacity: 1;
        }
        to {
            transform: translate(-50%, -100%);
            opacity: 0;
        }
    }

    /* Estils per les connexions */
    .connection-line {
        position: absolute;
        pointer-events: none;
        z-index: 1;
    }

    .connection-line path {
        stroke: #0d6efd;
        stroke-width: 2;
        fill: none;
        stroke-dasharray: 4;
        animation: dash 1s linear infinite;
    }

    @keyframes dash {
        to {
            stroke-dashoffset: -8;
        }
    }

    /* Custom styles for Model Designer Accordion */
    .metric-cards .accordion-item {
        border: 1px solid #dee2e6;
        border-radius: .5rem;
        margin-bottom: .75rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: box-shadow 0.2s ease-in-out;
    }

    .metric-cards .accordion-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .metric-cards .accordion-button {
        background-color: #fff;
        font-weight: 500;
        color: #212529;
        padding: 1rem 1.25rem;
    }

    .metric-cards .accordion-button:not(.collapsed) {
        color: #0d6efd;
        background-color: #f8f9fa;
        box-shadow: none;
    }

    .metric-cards .accordion-button:focus {
        box-shadow: 0 0 0 .25rem rgba(13,110,253,.25);
    }

    .metric-cards .accordion-button::after {
        display: none;
    }

    .metric-cards .accordion-body {
        background-color: #fcfdff;
        padding: 1rem 1.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Workflow Stepper -->
    {% include 'webapp/includes/stepper.html' with active_step=2 %}
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-project-diagram me-2"></i>Model Designer</h2>
            <p class="text-muted">Design neural network architectures for federated training</p>
        </div>
        <div>
            <button id="load-model-btn" class="btn btn-outline-primary me-2">
                <i class="fas fa-folder-open me-1"></i>Load Model
            </button>
            <button id="preview-json-btn" class="btn btn-outline-secondary me-2">
                <i class="fas fa-code me-1"></i>Preview JSON
            </button>
            <button id="save-model-btn" class="btn btn-primary me-2">
                <i class="fas fa-save me-1"></i>Save Model
            </button>
            <button id="go-to-training-btn" class="btn btn-success">
                <i class="fas fa-play-circle me-1"></i>Go to Training
            </button>
        </div>
    </div>
    
    <div class="row d-flex align-items-stretch">
        <!-- Panel de Configuraci贸 -->
        <div class="col-md-4 d-flex">
            <div class="card model-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="model-config-form">
                        <div class="mb-3">
                            <label for="model-name" class="form-label">Model Name</label>
                            <input type="text" class="form-control" id="model-name" placeholder="My model">
                        </div>
                        
                        <div class="mb-3">
                            <label for="framework" class="form-label">Framework</label>
                            <select class="form-select" id="framework">
                                <option value="pytorch" selected>PyTorch</option>
                                <option value="tensorflow">TensorFlow</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3">Optimizer</h6>
                        <div class="mb-3">
                            <select class="form-select" id="optimizer-type">
                                <option value="adam" selected>Adam</option>
                                <option value="sgd">SGD</option>
                                <option value="rmsprop">RMSprop</option>
                            </select>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label for="learning-rate" class="form-label d-flex align-items-center">
                                    Learning Rate
                                    <i class="fas fa-question-circle help-icon ms-2" data-bs-toggle="tooltip" data-bs-placement="right" title="Controls the step size at each iteration while moving toward a minimum of the loss function"></i>
                                </label>
                                <input type="number" class="form-control" id="learning-rate" value="0.001" step="0.0001" min="0.0001">
                            </div>
                            <div class="col-6">
                                <label for="weight-decay" class="form-label d-flex align-items-center">
                                    Weight Decay
                                    <i class="fas fa-question-circle help-icon ms-2" data-bs-toggle="tooltip" data-bs-placement="right" title="L2 penalty term for regularization to prevent overfitting"></i>
                                </label>
                                <input type="number" class="form-control" id="weight-decay" value="0" step="0.0001" min="0">
                            </div>
                        </div>

                        <!-- Differential Privacy Accordion -->
                        <div class="accordion metric-cards mb-3" id="optimizerAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDifferentialPrivacy">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-shield-alt me-2 text-primary"></i>
                                                <strong>Differential Privacy Parameters</strong>
                                                <div class="d-block text-muted fw-normal small" id="dp-summary">
                                                    Noise: <strong id="noise-summary" class="text-dark">1.0</strong> |
                                                    Max Norm: <strong id="norm-summary" class="text-dark">1.0</strong> |
                                                    Seed: <strong id="seed-summary" class="text-dark">42</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapseDifferentialPrivacy" class="accordion-collapse collapse" data-bs-parent="#optimizerAccordion">
                                    <div class="accordion-body">
                                        <p class="text-muted small mb-3">Configure privacy-preserving training parameters for federated learning</p>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="noise-multiplier" class="form-label d-flex align-items-center">
                                                    Random Noise
                                                    <i class="fas fa-question-circle help-icon ms-2" data-bs-toggle="tooltip" data-bs-placement="right" title="Noise multiplier for differential privacy. Higher values provide more privacy but may reduce model accuracy. Minimum value is 1.0"></i>
                                                </label>
                                                <input type="number" class="form-control" id="noise-multiplier" value="1.0" step="0.1" min="1.0">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="max-grad-norm" class="form-label d-flex align-items-center">
                                                    Max Grad Norm
                                                    <i class="fas fa-question-circle help-icon ms-2" data-bs-toggle="tooltip" data-bs-placement="right" title="Maximum norm of the per-sample gradients. Used for gradient clipping in differential privacy"></i>
                                                </label>
                                                <input type="number" class="form-control" id="max-grad-norm" value="1.0" step="0.1" min="0.1">
                                            </div>
                                            <div class="col-md-12">
                                                <label for="dp-seed" class="form-label d-flex align-items-center">
                                                    Random Seed
                                                    <i class="fas fa-question-circle help-icon ms-2" data-bs-toggle="tooltip" data-bs-placement="right" title="Seed for the random noise generator to ensure reproducible experiments"></i>
                                                </label>
                                                <input type="number" class="form-control" id="dp-seed" value="42" step="1" min="0" style="max-width: 200px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3">Loss Function</h6>
                        <div class="mb-3">
                            <select class="form-select" id="loss-function">
                                <option value="bce_with_logits" selected>Binary Cross Entropy with Logits</option>
                                <option value="cross_entropy">Cross Entropy</option>
                                <option value="mse">Mean Squared Error</option>
                            </select>
                            <div class="form-text" id="loss-recommendation-info" style="display: none;">
                                <i class="fas fa-magic text-primary"></i> Auto-configured based on dataset metadata
                            </div>
                        </div>
    
                        
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Panel de Capes -->
        <div class="col-md-4">
            <div class="card model-card h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Layers</h5>
                    <button class="btn btn-sm btn-light btn-add-layer" id="add-layer-btn">
                        <i class="fas fa-plus me-1"></i>Add Layer
                    </button>
                </div>
                <div class="card-body" id="layers-container">
                    <!-- Input Layer -->
                    <div class="layer-box input-layer" data-layer-id="input">
                        <div>Input Layer</div>
                        <div class="layer-features">Features: 12</div>
                    </div>
                    
                    <div class="layer-connector"></div>
                    
                    <!-- Output Layer -->
                    <div class="layer-box output-layer" data-layer-id="output">
                        <div>Output Layer</div>
                        <div class="layer-features">Features: 1</div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button id="clear-layers-btn" class="btn btn-sm btn-danger">
                            <i class="fas fa-trash me-1"></i>Clear Layers
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Parmetres de Capa -->
        <div class="col-md-4 d-flex">
            <div class="card model-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Layer Parameters</h5>
                </div>
                <div class="card-body" id="layer-params-container">
                    <!-- Placeholder when no layer is selected -->
                    <div class="param-placeholder">
                        <div class="hand-pointer">
                            <i class="fas fa-hand-pointer"></i>
                        </div>
                        <h5>Select a layer to configure its parameters.</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per Afegir Capa -->
<div class="modal fade" id="add-layer-modal" tabindex="-1" aria-labelledby="add-layer-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="add-layer-modal-label">Add New Layer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="layer-type" class="form-label">Layer Type</label>
                    <select class="form-select" id="layer-type">
                        <optgroup label="Linear Layers">
                        <option value="linear" selected>Linear (Fully Connected)</option>
                        </optgroup>
                        <optgroup label="Convolutional Layers">
                        <option value="conv1d">Conv1d</option>
                        <option value="conv2d">Conv2d</option>
                        </optgroup>
                        <optgroup label="Normalization Layers">
                        <option value="batch_norm1d">BatchNorm1d</option>
                            <option value="batch_norm2d">BatchNorm2d</option>
                        </optgroup>
                        <optgroup label="Pooling Layers">
                        <option value="maxpool1d">MaxPool1d</option>
                            <option value="maxpool2d">MaxPool2d</option>
                        <option value="avgpool1d">AvgPool1d</option>
                            <option value="avgpool2d">AvgPool2d</option>
                        <option value="adaptive_avg_pool1d">AdaptiveAvgPool1d</option>
                        </optgroup>
                        <optgroup label="Activation Layers">
                            <option value="activation_relu">ReLU</option>
                            <option value="activation_sigmoid">Sigmoid</option>
                            <option value="activation_softmax">Softmax</option>
                            <option value="activation_tanh">Tanh</option>
                            <option value="activation_leakyrelu">LeakyReLU</option>
                        </optgroup>
                        <optgroup label="Recurrent Layers">
                            <option value="lstm">LSTM</option>
                            <option value="gru">GRU</option>
                        </optgroup>
                        <optgroup label="Utility Layers">
                            <option value="dropout">Dropout</option>
                            <option value="flatten">Flatten</option>
                        </optgroup>
                    </select>
                </div>
                
                <div id="layer-params-form">
                    <!-- Parameters will be loaded dynamically based on layer type -->
                    <div class="mb-3" id="linear-params">
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="in-features" class="form-label">In Features</label>
                                <input type="number" class="form-control" id="in-features" value="64" min="1">
                            </div>
                            <div class="col-6">
                                <label for="out-features" class="form-label">Out Features</label>
                                <input type="number" class="form-control" id="out-features" value="64" min="1">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="use-bias" checked>
                            <label class="form-check-label" for="use-bias">
                                Use Bias
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-add-layer">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal per Vista Pr猫via JSON -->
<div class="modal fade" id="json-preview-modal" tabindex="-1" aria-labelledby="json-preview-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="json-preview-modal-label">Model JSON Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded" id="json-preview"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copy-json-btn">
                    <i class="fas fa-copy me-1"></i>Copy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaci贸n para limpiar capas -->
<div class="modal fade" id="clearLayersModal" tabindex="-1" aria-labelledby="clearLayersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="clearLayersModalLabel"><i class="fas fa-trash me-2"></i>Clear Layers</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete all the layers of the model?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-clear-layers-btn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de validaci贸n -->
<div class="modal fade" id="validation-errors-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Validation Errors
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please, correct the following errors before continuing:</p>
                <ul id="validation-errors-list" class="list-group list-group-flush">
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- A帽adir este modal al HTML, junto con los otros modales -->
<div class="modal fade" id="removeLayerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash me-2"></i>Delete Layer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this layer?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-remove-layer-btn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
let modelLayers = []; // Initialize as an empty array globally

// Funci贸 moguda a l'mbit global
function getDisplayName(layer) {
    if (!layer) return 'Unknown Layer'; // Protecci贸 addicional
    if (layer.id === 'input') return 'Input Layer';
    if (layer.id === 'output') return 'Output Layer';
    
    // Assegurem que modelLayers 茅s un array abans de filtrar
    const layersSoFar = Array.isArray(modelLayers) ? modelLayers : [];
    const typeCount = layersSoFar
        .filter(l => l.name === layer.name && l.id < layer.id)
        .length + 1;
    
    return `${layer.name} ${typeCount}`;
}

function isValidConnection(sourceId, targetId) {
    // Simplified validation - only check basic rules
    if (sourceId === targetId) return false;
    if (targetId === 'input') return false;
    if (sourceId === 'output') return false;
    if (wouldCreateCycle(sourceId, targetId)) return false;
    return true;
}

function wouldCreateCycle(sourceId, targetId) {
    // Implementar detecci贸 de cicles utilitzant DFS
    const visited = new Set();
    
    function dfs(currentId) {
        if (currentId === sourceId) return true;
        if (visited.has(currentId)) return false;
        
        visited.add(currentId);
        const layer = modelLayers.find(l => l.id === currentId);
        // Assegurem que layer i layer.params existeixen abans d'accedir a inputs
        if (!layer || !layer.params || !layer.params.inputs) return false; 
        
        return layer.params.inputs.some(inputId => dfs(inputId));
    }
    
    return dfs(targetId);
}

function createConnection(sourceId, targetId) {
    // Simplified connection creation
    updateLayerConnections(sourceId, targetId);
    renderLayers(); // Update the UI
}

function updateLayerConnections(sourceId, targetId) {
    const targetLayer = modelLayers.find(l => l.id === targetId);
    if (!targetLayer.params.inputs) {
        targetLayer.params.inputs = [];
    }
    
    // Sequential models only - no special connection handling needed
}

function renderLayers() {
    const layersList = document.createElement('div');
    layersList.className = 'layers-list';

    modelLayers.forEach((layer, index) => {
        const layerBox = document.createElement('div');
        layerBox.className = `layer-box ${layer.category || layer.type}-layer`;
        layerBox.setAttribute('data-layer-id', layer.id);
        
        // Crear el contingut de la capa primer
        const layerContent = document.createElement('div');
        layerContent.className = 'layer-content';
        
        const layerName = document.createElement('div');
        layerName.textContent = getDisplayName(layer);
        
        const layerFeatures = document.createElement('div');
        layerFeatures.className = 'layer-features';
        layerFeatures.textContent = `Features: ${layer.params.features}`;
        
        layerContent.appendChild(layerName);
        layerContent.appendChild(layerFeatures);
        layerBox.appendChild(layerContent);


        // Afegir event listener per seleccionar la capa
        layerBox.addEventListener('click', function() {
            selectLayer(layer.id);
        });
        
        layersList.appendChild(layerBox);
        
        // Connector (except after the last layer)
        if (index < modelLayers.length - 1) {
            const connector = document.createElement('div');
            connector.className = 'layer-connector';
            layersList.appendChild(connector);
        }
    });
    
    // Clean the main container
    const layersContainer = document.getElementById('layers-container');
    layersContainer.innerHTML = '';
    
    // Add the layers list
    layersContainer.appendChild(layersList);
    
    // Add the fixed buttons below
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'text-center mt-3 pt-2 border-top';
    buttonsDiv.style.position = 'sticky';
    buttonsDiv.style.bottom = '0';
    buttonsDiv.style.backgroundColor = '#fff';
    buttonsDiv.innerHTML = `
        <button id="clear-layers-btn" class="btn btn-sm btn-danger">
            <i class="fas fa-trash me-1"></i>Clear Layers
        </button>
    `;
    layersContainer.appendChild(buttonsDiv);

    // Re-attach event listeners
    document.getElementById('clear-layers-btn').addEventListener('click', function() {
        // Replace the current confirmation with the opening of the modal
        const clearLayersModal = new bootstrap.Modal(document.getElementById('clearLayersModal'));
        clearLayersModal.show();
    });
    
}

document.addEventListener('DOMContentLoaded', function() {
    // Elements globals
    const layersContainer = document.getElementById('layers-container');
    const paramsContainer = document.getElementById('layer-params-container');
    const addLayerBtn = document.getElementById('add-layer-btn');
    const clearLayersBtn = document.getElementById('clear-layers-btn');
    const previewJsonBtn = document.getElementById('preview-json-btn');
    const saveModelBtn = document.getElementById('save-model-btn');
    const loadModelBtn = document.getElementById('load-model-btn');
    
    // Modals - DECLARAR GLOBALMENT
    window.addLayerModal = new bootstrap.Modal(document.getElementById('add-layer-modal'));
    window.jsonPreviewModal = new bootstrap.Modal(document.getElementById('json-preview-modal'));
    
    // Estat del model
    let selectedLayerId = null;
    
    // Event Listeners - NICS I GLOBALS
    addLayerBtn.addEventListener('click', function() {
        // Configurar valors automtics basats en la capa anterior
        const previousLayer = modelLayers[modelLayers.length - 2]; // Capa anterior a output
        
        setTimeout(() => {
            // Per Linear layers
            const inFeaturesInput = document.getElementById('in-features');
            if (inFeaturesInput && previousLayer) {
                inFeaturesInput.value = previousLayer.params.features || 64;
            }
            
            // Per Conv layers
            const inChannelsInput = document.getElementById('in-channels');
            if (inChannelsInput && previousLayer) {
                inChannelsInput.value = previousLayer.params.out_channels || previousLayer.params.features || 1;
            }
        }, 100);
        
        window.addLayerModal.show();
    });
    
    document.getElementById('confirm-add-layer').addEventListener('click', function() {
        addLayer();
        window.addLayerModal.hide();
    });
    
    clearLayersBtn.addEventListener('click', function() {
        // Reemplazar la confirmaci贸n actual con la apertura del modal
        const clearLayersModal = new bootstrap.Modal(document.getElementById('clearLayersModal'));
        clearLayersModal.show();
    });
    
    previewJsonBtn.addEventListener('click', function() {
        updateJsonPreview();
        window.jsonPreviewModal.show();
    });
    
    document.getElementById('copy-json-btn').addEventListener('click', function() {
        const jsonText = document.getElementById('json-preview').textContent;
        navigator.clipboard.writeText(jsonText).then(function() {
            showMessage('JSON copied to clipboard!', 'success');
        });
    });
    
    saveModelBtn.addEventListener('click', function() {
        saveModel();
    });
    
    loadModelBtn.addEventListener('click', function() {
        // Obtenir els models de model_configs que ja tenim al context
        const modelConfigsJSON = '{{ model_configs|json_string|escapejs }}';
        const modelConfigs = JSON.parse(modelConfigsJSON);
        
        if (!Array.isArray(modelConfigs) || modelConfigs.length === 0) {
            showMessage('No saved models found', 'info');
            return;
        }
        
        // Crear un modal dinmic per mostrar els models desats
        const modelHTML = `
            <div class="modal fade" id="loadModelModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header d-flex align-items-center">
                            <h5 class="modal-title">Load Model</h5>
                            <button type="button" class="btn btn-outline-secondary btn-sm mx-2" id="refresh-models-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="list-group" id="models-list">
                                ${modelConfigs.map(model => `
                                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        <div class="d-flex flex-column" style="cursor: pointer" data-model-id="${model.id}">
                                            <h6 class="mb-1">${model.name}</h6>
                                            <small class="text-muted">${model.created_at}</small>
                                        </div>
                                        <button class="btn btn-outline-danger btn-sm delete-model-btn" data-model-id="${model.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Afegir el modal al document
        const modelContainer = document.createElement('div');
        modelContainer.innerHTML = modelHTML;
        document.body.appendChild(modelContainer);
        
        // Mostrar el modal
        const loadModal = new bootstrap.Modal(document.getElementById('loadModelModal'));
        loadModal.show();
        
        // Definir la funci贸 attachModelEventListeners
        function attachModelEventListeners() {
            // Event listeners per carregar models
            document.querySelectorAll('[data-model-id]').forEach(item => {
                item.addEventListener('click', function() {
                    const modelId = this.getAttribute('data-model-id');
                    
                    // Fer una crida a l'API per obtenir la configuraci贸 del model
                    fetch(`/api/get-model-config/${modelId}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (!data) {
                                throw new Error("No data received from API");
                            }

                            if (!data.id || !data.name) {
                                throw new Error("Response does not contain expected model data");
                            }
                            
                            // Extreure la configuraci贸 del model
                            const modelConfig = data.config_json || {};
                            
                            try {
                                loadModelFromConfig({
                                    name: data.name,
                                    framework: data.framework || 'pytorch',
                                    description: data.description || '',
                                    ...modelConfig
                                });
                                loadModal.hide();
                                showMessage(`Model "${data.name}" loaded correctly`, 'success');
                            } catch (loadError) {
                                throw loadError;
                            }
                        })
                        .catch(error => {
                            console.error('Err:', error.message);
                            showMessage(`Error loading model: ${error.message}`, 'error');
                        });
                });
            });

            // Event listeners per eliminar models
            document.querySelectorAll('.delete-model-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();  // Evitar que es propagui al pare
                    const modelId = this.getAttribute('data-model-id');
                    deleteModel(modelId);
                });
            });
        }

        // Definir la funci贸 refreshModelsList
        function refreshModelsList() {
            const refreshBtn = document.getElementById('refresh-models-btn');
            const icon = refreshBtn.querySelector('i');
            
            icon.classList.add('fa-spin');
            
            fetch('/api/get-model-configs/?type=dl')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modelsList = document.getElementById('models-list');
                        modelsList.innerHTML = data.models.map(model => `
                            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div class="d-flex flex-column" style="cursor: pointer" data-model-id="${model.id}">
                                    <h6 class="mb-1">${model.name}</h6>
                                    <small class="text-muted">${model.created_at}</small>
                                </div>
                                <button class="btn btn-outline-danger btn-sm delete-model-btn" data-model-id="${model.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('');
                        
                        attachModelEventListeners();
                        showMessage('Models list updated', 'success');
                    } else {
                        throw new Error(data.error);
                    }
                })
                .catch(error => {
                    showMessage('Error in refreshing the models: ' + error, 'error');
                })
                .finally(() => {
                    icon.classList.remove('fa-spin');
                });
        }
            // Definir la funci贸 deleteModel
        function deleteModel(modelId) {
            if (confirm('Are you sure you want to delete this model?')) {
                fetch(`/api/delete-model-config/${modelId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('Model deleted correctly', 'success');
                        // Call refreshModelsList instead of manually deleting
                        refreshModelsList();
                        } else {
                        throw new Error(data.error);
                    }
            })
            .catch(error => {
                showMessage('Error in deleting the model: ' + error, 'error');
            });
        }
    }

        // Add the refresh models button event listener
        document.getElementById('refresh-models-btn').addEventListener('click', refreshModelsList);
        
        // Add the initial event listeners
        attachModelEventListeners();
        
        // Remove the modal from the DOM once closed
        document.getElementById('loadModelModal').addEventListener('hidden.bs.modal', function() {
            modelContainer.remove();
        });
    });
    
    // Change layer type in the modal
    document.getElementById('layer-type').addEventListener('change', function() {
        updateLayerParamsForm(this.value);
    });
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Validation for differential privacy parameters
    document.getElementById('noise-multiplier').addEventListener('blur', function() {
        const value = parseFloat(this.value);
        if (value < 1.0) {
            this.value = 1.0;
            showMessage('Random noise multiplier cannot be less than 1.0', 'warning');
        }
    });

    // Additional validation on form submission to prevent invalid values
    document.getElementById('model-config-form').addEventListener('submit', function(e) {
        const noiseValue = parseFloat(document.getElementById('noise-multiplier').value);
        if (noiseValue < 1.0) {
            e.preventDefault();
            document.getElementById('noise-multiplier').value = 1.0;
            showMessage('Random noise multiplier has been corrected to minimum value of 1.0', 'info');
        }
    });

    // Function to update differential privacy summary
    function updateDPSummary() {
        const noise = document.getElementById('noise-multiplier').value;
        const norm = document.getElementById('max-grad-norm').value;
        const seed = document.getElementById('dp-seed').value;

        document.getElementById('noise-summary').textContent = noise || '...';
        document.getElementById('norm-summary').textContent = norm || '...';
        document.getElementById('seed-summary').textContent = seed || '...';
    }

    // Add event listeners for real-time summary updates
    const dpInputs = ['noise-multiplier', 'max-grad-norm', 'dp-seed'];
    dpInputs.forEach(inputId => {
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.addEventListener('input', updateDPSummary);
        }
    });

    // Initial call on page load
    updateDPSummary();

    // Initialization
    initializeModel(); // This function will now populate the global modelLayers

    // Check if we're in edit mode and load the model
    {% if edit_mode and edit_model_json %}
    try {
        const configString = '{{ edit_model_json|json_string|escapejs }}';
        const editModelConfig = JSON.parse(configString);        
        // Load the model configuration
        if (editModelConfig && Object.keys(editModelConfig).length > 0) {
            // Ensure layers are in the correct structure
            let configToLoad = {
                name: '{{ edit_model.name|escapejs }}',
                framework: '{{ edit_model.framework|escapejs }}',
                description: '{{ edit_model.description|escapejs }}',
                ...editModelConfig
            };
            
            // Fix layers structure if needed
            if (!configToLoad.layers && editModelConfig.config && editModelConfig.config.layers) {
                configToLoad.layers = editModelConfig.config.layers;
            } else if (!configToLoad.layers && editModelConfig.model && editModelConfig.model.layers) {
                configToLoad.layers = editModelConfig.model.layers;
            }            
            loadModelFromConfig(configToLoad);
            showMessage('Model loaded for editing', 'success');
        }
    } catch (error) {
        console.error(' DEBUG: Error loading model in edit mode:', error);
        showMessage('Error loading model for editing: ' + error.message, 'error');
    }
    {% endif %}
    
    // Check if there is a dataset in the URL and configure the model
    if (typeof checkAndLoadDataset === 'function') {
        checkAndLoadDataset();
    }
    
    // Funcions
    function initializeModel() {
        // Get input features and target info from selected datasets
        const selectedDatasets = {{ selected_datasets|default:'[]'|to_json }};

        let inputFeatures = 1; // Default value
        let outputFeatures = 1; // Default value for binary classification

        if (selectedDatasets && selectedDatasets.length > 0) {
            const dataset = selectedDatasets[0];
            console.log(dataset);
            // Get input features from features_info
            if (dataset.features_info && dataset.features_info.input_features) {
                inputFeatures = dataset.features_info.input_features;
            }
            // Get output features from target_info
            if (dataset.target_info) {
                // Use output_neurons from metadata if available, otherwise calculate
                if (dataset.target_info.output_neurons !== undefined && dataset.target_info.output_neurons > 0) {
                    outputFeatures = dataset.target_info.output_neurons;
                } else if (dataset.target_info.num_classes) {
                    // Fallback: For binary classification we use 1 output (sigmoid)
                    // For multiclass we use num_classes outputs (softmax)
                    outputFeatures = dataset.target_info.type === 'binary_classification' ? 1 : dataset.target_info.num_classes;
                }
            }
        }

        // Initialize empty model with input and output layers
        modelLayers = [
            {
                id: 'input',
                name: 'Input Layer',
                type: 'input',
                params: {
                    features: inputFeatures
                },
                fixed: true,
                readonly: true
            },
            {
                id: 'output',
                name: 'Output Layer',
                type: 'output',
                params: {
                    features: outputFeatures
                },
                fixed: true,
                readonly: true
            }
        ];

        // Configure recommended loss function from target_info
        if (selectedDatasets && selectedDatasets.length > 0) {
            const dataset = selectedDatasets[0];
            if (dataset.target_info && dataset.target_info.recommended_loss) {
                const lossElement = document.getElementById('loss-function');
                const lossInfoElement = document.getElementById('loss-recommendation-info');
                if (lossElement) {
                    const recommendedLoss = dataset.target_info.recommended_loss;
                    // Map PyTorch loss names to our select options
                    const lossMapping = {
                        'CrossEntropyLoss': 'cross_entropy',
                        'BCEWithLogitsLoss': 'bce_with_logits',
                        'BCELoss': 'bce_with_logits',
                        'MSELoss': 'mse',
                        'NLLLoss': 'cross_entropy'
                    };
                    const mappedLoss = lossMapping[recommendedLoss] || 'bce_with_logits';
                    const option = lossElement.querySelector(`option[value="${mappedLoss}"]`);
                    if (option) {
                        lossElement.value = mappedLoss;
                        // Show recommendation info
                        if (lossInfoElement) {
                            lossInfoElement.style.display = 'block';
                        }
                    }
                }
            }
        }

        renderLayers();
    }
    
    function renderLayers() {
        // Separate the buttons and the container of layers
        const layersList = document.createElement('div');
        layersList.className = 'layers-list mb-3';
        layersList.style.overflow = 'auto';
        layersList.style.maxHeight = 'calc(100% - 60px)';  // Reserve space for the buttons
        
        // Render layers
        modelLayers.forEach((layer, index) => {
            // Layer box
            const layerBox = document.createElement('div');
            layerBox.className = `layer-box ${layer.category || layer.type}-layer`;
            layerBox.setAttribute('data-layer-id', layer.id);
            
            // Crear contingut correctament amb DOM
            const layerContent = document.createElement('div');
            layerContent.textContent = getDisplayName(layer);
            const layerFeatures = document.createElement('div');
            layerFeatures.className = 'layer-features';
            layerFeatures.textContent = `Features: ${layer.params.features}`;
            layerBox.appendChild(layerContent);
            layerBox.appendChild(layerFeatures);

            // Click event
            layerBox.addEventListener('click', function() {
                selectLayer(layer.id);
            });
            
            layersList.appendChild(layerBox);
            
            // Connector (except after the last layer)
            if (index < modelLayers.length - 1) {
                const connector = document.createElement('div');
                connector.className = 'layer-connector';
                layersList.appendChild(connector);
            }
        });
        
        // Clean the main container
        const layersContainer = document.getElementById('layers-container');
        layersContainer.innerHTML = '';
        
        // Add the layers list
        layersContainer.appendChild(layersList);
        
        // Add the fixed buttons below
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'text-center mt-3 pt-2 border-top';
        buttonsDiv.style.position = 'sticky';
        buttonsDiv.style.bottom = '0';
        buttonsDiv.style.backgroundColor = '#fff';
        buttonsDiv.innerHTML = `
            <button id="clear-layers-btn" class="btn btn-sm btn-danger">
                <i class="fas fa-trash me-1"></i>Clear Layers
            </button>
        `;
        layersContainer.appendChild(buttonsDiv);
        
        // Re-attach event listeners
        document.getElementById('clear-layers-btn').addEventListener('click', function() {
            // Replace the current confirmation with the opening of the modal
            const clearLayersModal = new bootstrap.Modal(document.getElementById('clearLayersModal'));
            clearLayersModal.show();
        });
    }
    
    function getLayerCategory(layerType) {
        if (layerType === 'input') return 'input';
        if (layerType === 'output') return 'output';
        if (layerType === 'linear' || layerType === 'Linear') return 'linear';
        if (layerType.startsWith('conv') || layerType.startsWith('Conv')) return 'conv';
        if (layerType.startsWith('activation_')) return 'activation';
        // Recognize PyTorch activation class names directly
        if (['ReLU', 'Sigmoid', 'Tanh', 'Softmax', 'LeakyReLU'].includes(layerType)) return 'activation';
        if (layerType.includes('pool') || layerType.includes('Pool')) return 'pool';
        if (layerType.includes('norm') || layerType.includes('Norm')) return 'norm';
        if (layerType === 'dropout' || layerType === 'Dropout') return 'dropout';
        if (layerType === 'flatten' || layerType === 'Flatten') return 'flatten';
        if (layerType === 'lstm' || layerType === 'gru' || layerType === 'LSTM' || layerType === 'GRU') return 'recurrent';
        return 'linear';
    }

    function addLayer() {
        const layerType = document.getElementById('layer-type').value;
        let layerName, layerParams, layerTypeCategory;

        // Determine layer type category first
        layerTypeCategory = getLayerCategory(layerType);
        
        switch (layerType) {
            case 'linear':
                const inFeatures = parseInt(document.getElementById('in-features').value);
                const outFeatures = parseInt(document.getElementById('out-features').value);
                const useBias = document.getElementById('use-bias').checked;
                
                // Agafar automticament les features de la capa anterior
                const previousLayer = modelLayers[modelLayers.length - 2]; // Capa anterior a output
                const actualInFeatures = previousLayer ? previousLayer.params.features : inFeatures;
                
                layerName = 'Linear';
                layerParams = {
                    in_features: actualInFeatures,
                    out_features: outFeatures,
                    bias: useBias,
                    features: outFeatures
                };
                break;
                
            case 'conv1d':
                const inChannels1d = parseInt(document.getElementById('in-channels').value);
                const outChannels1d = parseInt(document.getElementById('out-channels').value);
                const kernelSize1d = parseInt(document.getElementById('kernel-size').value);
                const stride1d = parseInt(document.getElementById('stride').value);
                const padding1d = document.getElementById('padding').value;
                
                // Agafar automticament els channels de la capa anterior
                const previousLayer1d = modelLayers[modelLayers.length - 2];
                const actualInChannels1d = previousLayer1d ? (previousLayer1d.params.out_channels || previousLayer1d.params.features || 1) : inChannels1d;
                
                layerName = 'Conv1d';
                layerParams = {
                    in_channels: actualInChannels1d,
                    out_channels: outChannels1d,
                    kernel_size: kernelSize1d,
                    stride: stride1d,
                    padding: padding1d,
                    features: outChannels1d
                };
                break;

            case 'conv2d':
                const inChannels2d = parseInt(document.getElementById('in-channels').value);
                const outChannels2d = parseInt(document.getElementById('out-channels').value);
                const kernelSize2d = parseInt(document.getElementById('kernel-size').value);
                const kernelSize2d2 = parseInt(document.getElementById('kernel-size-2').value);
                const stride2d = parseInt(document.getElementById('stride').value);
                const padding2d = document.getElementById('padding').value;
                
                // Agafar automticament els channels de la capa anterior
                const previousLayer2d = modelLayers[modelLayers.length - 2];
                const actualInChannels2d = previousLayer2d ? (previousLayer2d.params.out_channels || previousLayer2d.params.features || 3) : inChannels2d;
                
                layerName = 'Conv2d';
                layerParams = {
                    in_channels: actualInChannels2d,
                    out_channels: outChannels2d,
                    kernel_size: kernelSize2d,
                    kernel_size_2: kernelSize2d2,
                    stride: stride2d,
                    padding: padding2d,
                    features: outChannels2d
                };
                break;

            case 'dropout':
                const dropoutRate = parseFloat(document.getElementById('dropout-rate').value);
                
                // Preservar les features de la capa anterior
                const previousLayerDropout = modelLayers[modelLayers.length - 2];
                const preservedFeatures = previousLayerDropout ? (previousLayerDropout.params.out_channels || previousLayerDropout.params.features || '') : '';
                
                layerName = 'Dropout';
                layerParams = {
                    p: dropoutRate,
                    features: preservedFeatures
                };
                break;
                
            case 'batch_norm1d':
                const numFeatures = parseInt(document.getElementById('num-features').value);
                const epsilon = parseFloat(document.getElementById('eps').value);
                const momentumValue = parseFloat(document.getElementById('momentum').value);
                const affine = document.getElementById('affine').checked;
                const trackRunningStats = document.getElementById('track-running-stats').checked;
                
                // Agafar automticament les features de la capa anterior
                const previousLayerBN1d = modelLayers[modelLayers.length - 2];
                const actualNumFeatures = previousLayerBN1d ? (previousLayerBN1d.params.out_channels || previousLayerBN1d.params.features || numFeatures) : numFeatures;
                
                layerName = 'BatchNorm1d';
                layerParams = {
                    num_features: actualNumFeatures,
                    eps: epsilon,
                    momentum: momentumValue,
                    affine: affine,
                    track_running_stats: trackRunningStats,
                    features: actualNumFeatures
                };
                break;
                
            case 'batch_norm2d':
                const numFeatures2d = parseInt(document.getElementById('num-features').value);
                const epsilon2d = parseFloat(document.getElementById('eps').value);
                const momentumValue2d = parseFloat(document.getElementById('momentum').value);
                const affine2d = document.getElementById('affine').checked;
                const trackRunningStats2d = document.getElementById('track-running-stats').checked;
                
                // Agafar automticament les features de la capa anterior
                const previousLayerBN2d = modelLayers[modelLayers.length - 2];
                const actualNumFeatures2d = previousLayerBN2d ? (previousLayerBN2d.params.out_channels || previousLayerBN2d.params.features || numFeatures2d) : numFeatures2d;
                
                layerName = 'BatchNorm2d';
                layerParams = {
                    num_features: actualNumFeatures2d,
                    eps: epsilon2d,
                    momentum: momentumValue2d,
                    affine: affine2d,
                    track_running_stats: trackRunningStats2d,
                    features: actualNumFeatures2d
                };
                break;

            case 'maxpool1d':
                const kernelSizePool1d = parseInt(document.getElementById('kernel-size-pool').value);
                const stridePool1d = parseInt(document.getElementById('stride-pool').value);
                const paddingPool1d = document.getElementById('padding-pool').value;
                
                layerName = 'MaxPool1d';
                layerParams = {
                    kernel_size: kernelSizePool1d,
                    stride: stridePool1d,
                    padding: paddingPool1d,
                    features: ''
                };
                break;

            case 'maxpool2d':
                const kernelSizePool2d = parseInt(document.getElementById('kernel-size-pool').value);
                const stridePool2d = parseInt(document.getElementById('stride-pool').value);
                const paddingPool2d = document.getElementById('padding-pool').value;
                
                layerName = 'MaxPool2d';
                layerParams = {
                    kernel_size: kernelSizePool2d,
                    stride: stridePool2d,
                    padding: paddingPool2d,
                    features: ''
                };
                break;

            case 'avgpool1d':
                const kernelSizeAvgPool1d = parseInt(document.getElementById('kernel-size-pool').value);
                const strideAvgPool1d = parseInt(document.getElementById('stride-pool').value);
                const paddingAvgPool1d = document.getElementById('padding-pool').value;
                
                layerName = 'AvgPool1d';
                layerParams = {
                    kernel_size: kernelSizeAvgPool1d,
                    stride: strideAvgPool1d,
                    padding: paddingAvgPool1d,
                    features: ''
                };
                break;

            case 'avgpool2d':
                const kernelSizeAvgPool2d = parseInt(document.getElementById('kernel-size-pool').value);
                const strideAvgPool2d = parseInt(document.getElementById('stride-pool').value);
                const paddingAvgPool2d = document.getElementById('padding-pool').value;
                
                layerName = 'AvgPool2d';
                layerParams = {
                    kernel_size: kernelSizeAvgPool2d,
                    stride: strideAvgPool2d,
                    padding: paddingAvgPool2d,
                    features: ''
                };
                break;

            case 'adaptive_avg_pool1d':
                const outputSizeAdaptive = parseInt(document.getElementById('output-size-adaptive').value);
                
                layerName = 'AdaptiveAvgPool1d';
                layerParams = {
                    output_size: outputSizeAdaptive,
                    features: ''
                };
                break;

            case 'flatten':
                layerName = 'Flatten';
                layerParams = {
                    features: ''
                };
                break;

            case 'activation_relu':
                const previousLayerReLU = modelLayers[modelLayers.length - 2];
                const featuresReLU = previousLayerReLU ? (previousLayerReLU.params.out_channels || previousLayerReLU.params.features || previousLayerReLU.params.hidden_size) : '';
                layerName = 'ReLU';
                layerParams = {
                    features: featuresReLU
                };
                break;

            case 'activation_sigmoid':
                const previousLayerSigmoid = modelLayers[modelLayers.length - 2];
                const featuresSigmoid = previousLayerSigmoid ? (previousLayerSigmoid.params.out_channels || previousLayerSigmoid.params.features || previousLayerSigmoid.params.hidden_size) : '';
                layerName = 'Sigmoid';
                layerParams = {
                    features: featuresSigmoid
                };
                break;

            case 'activation_softmax':
                const previousLayerSoftmax = modelLayers[modelLayers.length - 2];
                const featuresSoftmax = previousLayerSoftmax ? (previousLayerSoftmax.params.out_channels || previousLayerSoftmax.params.features || previousLayerSoftmax.params.hidden_size) : '';
                layerName = 'Softmax';
                layerParams = {
                    dim: 1,
                    features: featuresSoftmax
                };
                break;

            case 'activation_tanh':
                const previousLayerTanh = modelLayers[modelLayers.length - 2];
                const featuresTanh = previousLayerTanh ? (previousLayerTanh.params.out_channels || previousLayerTanh.params.features || previousLayerTanh.params.hidden_size) : '';
                layerName = 'Tanh';
                layerParams = {
                    features: featuresTanh
                };
                break;

            case 'activation_leakyrelu':
                const negativeSlope = parseFloat(document.getElementById('negative-slope').value);
                const previousLayerLeaky = modelLayers[modelLayers.length - 2];
                const featuresLeaky = previousLayerLeaky ? (previousLayerLeaky.params.out_channels || previousLayerLeaky.params.features || previousLayerLeaky.params.hidden_size) : '';
                layerName = 'LeakyReLU';
                layerParams = {
                    negative_slope: negativeSlope,
                    features: featuresLeaky
                };
                break;

            case 'lstm':
                const inputSize = parseInt(document.getElementById('input-size').value);
                const hiddenSize = parseInt(document.getElementById('hidden-size').value);
                const numLayers = parseInt(document.getElementById('num-layers').value);
                const bidirectional = document.getElementById('bidirectional').checked;
                const batchFirst = document.getElementById('batch-first').checked;
                
                // Agafar automticament l'input_size de la capa anterior
                const previousLayerLSTM = modelLayers[modelLayers.length - 2];
                const actualInputSize = previousLayerLSTM ? (previousLayerLSTM.params.out_channels || previousLayerLSTM.params.features || inputSize) : inputSize;
                
                layerName = 'LSTM';
                layerParams = {
                    input_size: actualInputSize,
                    hidden_size: hiddenSize,
                    num_layers: numLayers,
                    bidirectional: bidirectional,
                    batch_first: batchFirst,
                    features: hiddenSize * (bidirectional ? 2 : 1)
                };
                break;

            case 'gru':
                const inputSizeGru = parseInt(document.getElementById('input-size').value);
                const hiddenSizeGru = parseInt(document.getElementById('hidden-size').value);
                const numLayersGru = parseInt(document.getElementById('num-layers').value);
                const bidirectionalGru = document.getElementById('bidirectional').checked;
                const batchFirstGru = document.getElementById('batch-first').checked;
                
                // Agafar automticament l'input_size de la capa anterior
                const previousLayerGRU = modelLayers[modelLayers.length - 2];
                const actualInputSizeGru = previousLayerGRU ? (previousLayerGRU.params.out_channels || previousLayerGRU.params.features || inputSizeGru) : inputSizeGru;
                
                layerName = 'GRU';
                layerParams = {
                    input_size: actualInputSizeGru,
                    hidden_size: hiddenSizeGru,
                    num_layers: numLayersGru,
                    bidirectional: bidirectionalGru,
                    batch_first: batchFirstGru,
                    features: hiddenSizeGru * (bidirectionalGru ? 2 : 1)
                };
                break;

            default:
                layerName = 'Custom Layer';
                layerParams = {
                    features: 64
                };
        }
        
        // Create new layer
        const newLayer = {
            id: 'layer_' + Date.now(),
            name: layerName,
            type: layerName,  // Use PyTorch class name directly (Linear, Conv2d, ReLU, etc.)
            category: layerTypeCategory,  // Keep category for UI purposes
            params: layerParams,
            fixed: false
        };
        
        // Insert before the output layer
        modelLayers.splice(modelLayers.length - 1, 0, newLayer);
        renderLayers();
        
        // Select the new layer
        selectLayer(newLayer.id);
    }

    function showAddInputModal(layerId) {
        // Get the index of the current layer
        const currentLayerIndex = modelLayers.findIndex(layer => layer.id === layerId);
        
        // Get available layers that can be inputs (only previous layers)
        const availableLayers = modelLayers
            .filter((layer, index) => {
                return index < currentLayerIndex && // Only previous layers
                       layer.id !== layerId && // Not the same layer
                       !layer.params.inputs?.includes(layerId) && // Avoid direct cycles
                       layer.id !== 'output'; // Not the output layer
            })
            .map(layer => ({
                id: layer.id,
                displayName: getDisplayName(layer)
            }));

        if (availableLayers.length === 0) {
            showMessage('No hi ha capes disponibles per connectar', 'warning');
            return;
        }

        // Remove any existing modal
        const existingModal = document.getElementById('add-input-modal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHtml = `
            <div class="modal fade" id="add-input-modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Enter Input Layer</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="input-layer-select" class="form-label">Select Input Layer</label>
                                <select class="form-select" id="input-layer-select">
                                    ${availableLayers.map(layer => `
                                        <option value="${layer.id}">${layer.displayName}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirm-add-input">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to document
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('add-input-modal'));
        modal.show();

        // Handle confirmation
        document.getElementById('confirm-add-input').addEventListener('click', function() {
            const selectedInput = document.getElementById('input-layer-select').value;
            addInput(layerId, selectedInput);
            modal.hide();
            modalContainer.remove();
        });

        // Clean up when modal is hidden
        document.getElementById('add-input-modal').addEventListener('hidden.bs.modal', function() {
            modalContainer.remove();
        });
    }
    
    function selectLayer(layerId) {
        // Desselect the current layer if there is one
        if (selectedLayerId) {
            const prevSelected = document.querySelector(`.layer-box[data-layer-id="${selectedLayerId}"]`);
            if (prevSelected) {
                prevSelected.classList.remove('border-primary');
                prevSelected.style.transform = '';
            }
        }
        
        selectedLayerId = layerId;
        
        // Highlight the selected layer
        const layerElement = document.querySelector(`.layer-box[data-layer-id="${layerId}"]`);
        if (layerElement) {
            layerElement.classList.add('border-primary');
            layerElement.style.transform = 'scale(1.05)';
            
            // Show parameters
            renderLayerParams(layerId);
        }
    }
    
    function renderLayerParams(layerId) {
        const layer = modelLayers.find(l => l.id === layerId);
        if (!layer) return;

        // Get the index of the current layer for filtering available inputs
        const currentLayerIndex = modelLayers.findIndex(l => l.id === layerId);
        
        // Get available layers that can be inputs (only previous layers)
        const availableLayers = modelLayers
            .slice(0, currentLayerIndex)  // Only take layers before current layer
            .filter(layer => 
                layer.id !== 'output' && // Not the output layer
                layer.id !== layerId && // Not the same layer
                !layer.params.inputs?.includes(layerId) // Avoid direct cycles
            );

        // Create the parameters form
        let paramsHtml = '';
        
        if (layer.id === 'input') {
            paramsHtml = `
                <h5 class="mb-3">${layer.name}</h5>
                <div class="mb-3">
                    <label for="param-input-features" class="form-label">Features</label>
                    <input type="number" class="form-control" id="param-input-features" 
                        value="${layer.params.features}" readonly 
                        data-param="features">
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Input features are automatically set based on the dataset features (${layer.params.features} features).
                </div>
            `;
        } else if (layer.id === 'output') {
            const selectedDatasets = {{ selected_datasets|default:'[]'|to_json }};
            let targetType = 'unknown';
            if (selectedDatasets && selectedDatasets.length > 0 && selectedDatasets[0].target_info) {
                targetType = selectedDatasets[0].target_info.type;
            }
            
            paramsHtml = `
                <h5 class="mb-3">${layer.name}</h5>
                <div class="mb-3">
                    <label for="param-output-features" class="form-label">Features</label>
                    <input type="number" class="form-control" id="param-output-features" 
                        value="${layer.params.features}" readonly 
                        data-param="features">
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Output features are automatically set based on the target type (${targetType}, ${layer.params.features} ${layer.params.features === 1 ? 'feature' : 'features'}).
                </div>
            `;
        } else {
            switch (layer.name) {
                case 'Linear':
                    if (layer.name === 'Linear') {
                        paramsHtml = `
                            <h5 class="mb-3">${layer.name} Parameters</h5>
                            <div class="mb-3">
                                <label for="param-in-features" class="form-label">In Features</label>
                                <input type="number" class="form-control" id="param-in-features" 
                                    value="${layer.params.in_features}" min="1" 
                                    data-param="in_features">
                            </div>
                            <div class="mb-3">
                                <label for="param-out-features" class="form-label">Out Features</label>
                                <input type="number" class="form-control" id="param-out-features" 
                                    value="${layer.params.out_features}" min="1" 
                                    data-param="out_features">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="param-bias" 
                                    ${layer.params.bias ? 'checked' : ''} data-param="bias">
                                <label class="form-check-label" for="param-bias">
                                    Utilitzar Bias
                                </label>
                            </div>

                        `;
                    }
                    break;

                case 'Conv1d':
                case 'Conv2d':
                case 'Conv3d':
                    const is2d = layer.name === 'Conv2d';
                    const is3d = layer.name === 'Conv3d';
                        paramsHtml = `
                        <h5 class="mb-3">${layer.name} Parameters</h5>
                            <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                <label for="param-in-channels" class="form-label">In Channels</label>
                                <input type="number" class="form-control" id="param-in-channels" 
                                    value="${layer.params.in_channels}" min="1" 
                                    data-param="in_channels">
                            </div>
                                <div class="col-6">
                                <label for="param-out-channels" class="form-label">Out Channels</label>
                                <input type="number" class="form-control" id="param-out-channels" 
                                    value="${layer.params.out_channels}" min="1" 
                                    data-param="out_channels">
                            </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col${is2d ? '-6' : ''}">
                                <label for="param-kernel-size" class="form-label">Kernel Size</label>
                                <input type="number" class="form-control" id="param-kernel-size" 
                                    value="${layer.params.kernel_size}" min="1" 
                                    data-param="kernel_size">
                            </div>
                                ${is2d ? `
                                <div class="col-6">
                                    <label for="param-kernel-size-2" class="form-label">Kernel Size 2</label>
                                    <input type="number" class="form-control" id="param-kernel-size-2" 
                                        value="${layer.params.kernel_size_2 || layer.params.kernel_size}" min="1" 
                                        data-param="kernel_size_2">
                                </div>
                                ` : ''}
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                <label for="param-stride" class="form-label">Stride</label>
                                <input type="number" class="form-control" id="param-stride" 
                                    value="${layer.params.stride}" min="1" 
                                    data-param="stride">
                            </div>
                                <div class="col-6">
                                <label for="param-padding" class="form-label">Padding</label>
                                <select class="form-select" id="param-padding" data-param="padding">
                                    <option value="same" ${layer.params.padding === 'same' ? 'selected' : ''}>same</option>
                                    <option value="valid" ${layer.params.padding === 'valid' ? 'selected' : ''}>valid</option>
                                </select>
                            </div>
                            </div>
                            </div>
                        `;
                    break;

                case 'BatchNorm1d':
                case 'BatchNorm2d':
                case 'BatchNorm3d':
                        paramsHtml = `
                        <h5 class="mb-3">${layer.name} Parameters</h5>
                            <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-12">
                                <label for="param-num-features" class="form-label">Num Features</label>
                                <input type="number" class="form-control" id="param-num-features" 
                                    value="${layer.params.num_features}" min="1" 
                                    data-param="num_features">
                            </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                <label for="param-eps" class="form-label">Epsilon</label>
                                <input type="number" class="form-control" id="param-eps" 
                                    value="${layer.params.eps}" min="0.00000001" step="0.00000001" 
                                    data-param="eps">
                            </div>
                                <div class="col-6">
                                <label for="param-momentum" class="form-label">Momentum</label>
                                <input type="number" class="form-control" id="param-momentum" 
                                    value="${layer.params.momentum}" min="0" max="1" step="0.01" 
                                    data-param="momentum">
                            </div>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="param-affine" 
                                    ${layer.params.affine ? 'checked' : ''} data-param="affine">
                                <label class="form-check-label" for="param-affine">
                                    Parmetres apresos (affine)
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="param-track-running-stats" 
                                    ${layer.params.track_running_stats ? 'checked' : ''} data-param="track_running_stats">
                                <label class="form-check-label" for="param-track-running-stats">
                                    Track Running Stats
                                </label>
                            </div>
                            </div>
                    `;
                    break;

                case 'MaxPool1d':
                case 'MaxPool2d':
                case 'MaxPool3d':
                case 'AvgPool1d':
                case 'AvgPool2d':
                case 'AvgPool3d':
                case 'AdaptiveAvgPool1d':
                case 'AdaptiveAvgPool2d':
                case 'AdaptiveAvgPool3d':
                    const isPool2d = layer.name.endsWith('2d');
                    paramsHtml = `
                        <h5 class="mb-3">${layer.name} Parameters</h5>
                        <div class="mb-3">
                            <div class="row g-2">
                                <div class="col${isPool2d ? '-12' : ''}">
                                    <label for="param-kernel-size-pool" class="form-label">Kernel Size</label>
                                    <input type="number" class="form-control" id="param-kernel-size-pool" 
                                        value="${layer.params.kernel_size}" min="1" 
                                        data-param="kernel_size">
                                </div>
                                
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                    <label for="param-stride-pool" class="form-label">Stride</label>
                                    <input type="number" class="form-control" id="param-stride-pool" 
                                        value="${layer.params.stride}" min="1" 
                                        data-param="stride">
                                </div>
                                <div class="col-6">
                                    <label for="param-padding-pool" class="form-label">Padding</label>
                                    <select class="form-select" id="param-padding-pool" data-param="padding">
                                        <option value="0" ${layer.params.padding === '0' ? 'selected' : ''}>0</option>
                                        <option value="1" ${layer.params.padding === '1' ? 'selected' : ''}>1</option>
                                        <option value="2" ${layer.params.padding === '2' ? 'selected' : ''}>2</option>
                                    </select>
                                </div>
                            </div>
                            </div>
                        `;
                    break;
                    
                case 'Dropout':
                    paramsHtml = `
                        <h5 class="mb-3">${layer.name} Parameters</h5>
                        <div class="mb-3">
                            <label for="param-dropout-rate" class="form-label">Dropout Rate</label>
                            <input type="number" class="form-control" id="param-dropout-rate" 
                                value="${layer.params.p}" min="0" max="1" step="0.1" 
                                data-param="p">
                            <div class="form-text">Probability of dropping out neurons during training.</div>
                        </div>
                    `;
                    break;

                case 'Flatten':
                    paramsHtml = `
                        <h5 class="mb-3">${layer.name} Parameters</h5>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>The Flatten layer has no configurable parameters.
                            Converts the input dimensions into a flat vector.
                        </div>
                    `;
                    break;

                case 'ReLU':
                case 'Sigmoid':
                case 'Tanh':
                case 'Softmax':
                case 'LeakyReLU':
                    paramsHtml = `
                        <h5 class="mb-3">${layer.name} Parameters</h5>
                        <div class="mb-3">
                            ${layer.name === 'LeakyReLU' ? `
                            <div class="mb-3">
                                <label for="param-negative-slope" class="form-label">Negative Slope</label>
                                <input type="number" class="form-control" id="param-negative-slope" 
                                    value="${layer.params.negative_slope || 0.01}" min="0" step="0.01" 
                                    data-param="negative_slope">
                            </div>
                            ` : `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>This activation function has no configurable parameters.
                            </div>
                            `}
                        </div>
                    `;
                    break;

                case 'LSTM':
                case 'GRU':
                case 'RNN':
                    paramsHtml = `
                        <h5 class="mb-3">${layer.name} Parameters</h5>
                        <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="param-input-size" class="form-label">Input Size</label>
                                    <input type="number" class="form-control" id="param-input-size" 
                                        value="${layer.params.input_size}" min="1" 
                                        data-param="input_size">
                                </div>
                                <div class="col-6">
                                    <label for="param-hidden-size" class="form-label">Hidden Size</label>
                                    <input type="number" class="form-control" id="param-hidden-size" 
                                        value="${layer.params.hidden_size}" min="1" 
                                        data-param="hidden_size">
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-12">
                                    <label for="param-num-layers" class="form-label">Number of Layers</label>
                                    <input type="number" class="form-control" id="param-num-layers" 
                                        value="${layer.params.num_layers}" min="1" 
                                        data-param="num_layers">
                                </div>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="param-bidirectional" 
                                    ${layer.params.bidirectional ? 'checked' : ''} data-param="bidirectional">
                                <label class="form-check-label" for="param-bidirectional">
                                    Bidirectional
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="param-batch-first" 
                                    ${layer.params.batch_first ? 'checked' : ''} data-param="batch_first">
                                <label class="form-check-label" for="param-batch-first">
                                    Batch First
                                </label>
                            </div>
                        </div>
                    `;
                    break;

                case 'Add':
                    paramsHtml = `
                            <h5 class="mb-3">Add Layer Parameters</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Add layer combines inputs by adding them element-wise.
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Input Layers</label>
                                <div id="add-inputs-list" class="list-group">
                                    ${layer.params.inputs.map(input => {
                                        const inputLayer = modelLayers.find(l => l.id === input);
                                        return `
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                ${inputLayer ? getDisplayName(inputLayer) : input}
                                                <button class="btn btn-sm btn-outline-danger remove-input" data-input="${input}">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" id="add-input-btn">
                                <i class="fas fa-plus me-1"></i>Add Input
                            </button>
                        `;
                        break;
                case 'Concat':
                        paramsHtml = `
                            <h5 class="mb-3">Concat Layer Parameters</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Concat layer combines inputs by concatenating them along a dimension.
                            </div>
                            <div class="mb-3">
                                <label for="concat-dim" class="form-label">Concatenation Dimension</label>
                                <input type="number" class="form-control" id="concat-dim" 
                                    value="${layer.params.dim}" min="0" data-param="dim">
                                <small class="text-muted">The dimension along which to concatenate the inputs (0 for batch, 1 for channels/features)</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Input Layers</label>
                                <div id="concat-inputs-list" class="list-group">
                                    ${layer.params.inputs.map(input => {
                                        const inputLayer = modelLayers.find(l => l.id === input);
                                        return `
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                ${inputLayer ? getDisplayName(inputLayer) : input}
                                                <button class="btn btn-sm btn-outline-danger remove-input" data-input="${input}">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" id="add-input-btn">
                                <i class="fas fa-plus me-1"></i>Add Input
                            </button>
                        `;
                    break;

                default:
                    paramsHtml = `
                        <h5 class="mb-3">Parameters</h5>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>This layer has no configurable parameters.
                    `;
            }

            // Add delete button for non-fixed layers
            if (!layer.fixed) {
                paramsHtml += `
                    <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-outline-danger" id="remove-layer-btn">
                                <i class="fas fa-trash me-1"></i>Delete Layer
                            </button>
                        </div>
                    `;
            }
        }
        
        // Update container
        paramsContainer.innerHTML = paramsHtml;
        
        // Add listener to remove layer
        const removeBtn = document.getElementById('remove-layer-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                const removeLayerModal = new bootstrap.Modal(document.getElementById('removeLayerModal'));
                removeLayerModal.show();
                
                // Configurar el bot贸n de confirmaci贸n
                document.getElementById('confirm-remove-layer-btn').onclick = function() {
                    removeLayer(layerId);
                };
            });
        }
        
        // Add listeners for changes in parameters
        const paramInputs = paramsContainer.querySelectorAll('[data-param]');
        paramInputs.forEach(input => {
            input.addEventListener('change', function() {
                updateLayerParam(layerId, this.dataset.param, 
                    this.type === 'checkbox' ? this.checked : 
                    (this.type === 'number' ? parseFloat(this.value) : this.value));
            });
        });

        // Add listeners for operation layers
        const addInputBtn = document.getElementById('add-input-btn');
        if (addInputBtn) {
            addInputBtn.addEventListener('click', function() {
                showAddInputModal(layerId);
            });
        }

        const removeInputBtns = document.querySelectorAll('.remove-input');
        removeInputBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const inputId = this.dataset.input;
                removeInput(layerId, inputId);
            });
        });
    }

    function showAddInputModal(layerId) {
        // Get available layers that can be inputs
        const availableLayers = modelLayers
            .filter(layer => layer.id !== layerId && !layer.params.inputs?.includes(layerId))
            .map(layer => ({
                id: layer.id,
                displayName: getDisplayName(layer)
            }));

        const modalHtml = `
            <div class="modal fade" id="add-input-modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Input Layer</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="input-layer-select" class="form-label">Select Input Layer</label>
                                <select class="form-select" id="input-layer-select">
                                    ${availableLayers.map(layer => `
                                        <option value="${layer.id}">${layer.displayName}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirm-add-input">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to document
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('add-input-modal'));
        modal.show();

        // Handle confirmation
        document.getElementById('confirm-add-input').addEventListener('click', function() {
            const selectedInput = document.getElementById('input-layer-select').value;
            addInput(layerId, selectedInput);
            modal.hide();
            modalContainer.remove();
        });

        // Clean up when modal is hidden
        document.getElementById('add-input-modal').addEventListener('hidden.bs.modal', function() {
            modalContainer.remove();
        });
    }

    function addInput(layerId, inputId) {
        const layerIndex = modelLayers.findIndex(l => l.id === layerId);
        const inputIndex = modelLayers.findIndex(l => l.id === inputId);
        
        if (layerIndex === -1) return;

        // Validate that we can only add previous layers
        if (inputIndex >= layerIndex) {
            showMessage('Nom茅s es poden connectar capes anteriors', 'warning');
            return;
        }

        const layer = modelLayers[layerIndex];
        const inputLayer = modelLayers.find(l => l.id === inputId);
        
        if (!inputLayer) return;

        // Validate that we're not connecting to output layer
        if (inputLayer.id === 'output') {
            showMessage('No es pot connectar a la capa de sortida', 'warning');
            return;
        }

        if (!layer.params.inputs) {
            layer.params.inputs = [];
        }

        // Validate that we don't create cycles
        if (wouldCreateCycle(inputId, layerId)) {
            showMessage('Aquesta connexi贸 crearia un cicle', 'warning');
            return;
        }

        layer.params.inputs.push(inputId);

        renderLayerParams(layerId);
        renderLayers(); // Re-render all layers to update features display
        showMessage('Input layer added', 'success');
    }

    function removeInput(layerId, inputId) {
        const layerIndex = modelLayers.findIndex(l => l.id === layerId);
        if (layerIndex === -1) return;

        const layer = modelLayers[layerIndex];
        const inputs = layer.params.inputs;
        if (!inputs) return;

        const inputIndex = inputs.indexOf(inputId);
        if (inputIndex > -1) {
            inputs.splice(inputIndex, 1);


            renderLayerParams(layerId);
            renderLayers(); // Re-render all layers to update features display
            showMessage('Input layer removed', 'success');
        }
    }
    
    function updateLayerParam(layerId, paramName, value) {
        const layerIndex = modelLayers.findIndex(l => l.id === layerId);
        if (layerIndex === -1) return;
        
        // Don't update if the layer is readonly
        if (modelLayers[layerIndex].readonly) {
            showMessage('Input layer features cannot be modified', 'warning');
            return;
        }
        
        modelLayers[layerIndex].params[paramName] = value;
        
        // Update the view if features, out_features or out_channels change
        if (paramName === 'features' || paramName === 'out_features' || paramName === 'out_channels') {
            // If out_features/out_channels change, also update features for consistency
            if (paramName === 'out_features' || paramName === 'out_channels') {
                modelLayers[layerIndex].params.features = value;
            }
            renderLayers();
            selectLayer(layerId);
        }
        
        showMessage('Parameter updated', 'success');
    }
    
    function removeLayer(layerId) {
        const layerIndex = modelLayers.findIndex(l => l.id === layerId);
        if (layerIndex === -1) return;
        
        // Abans d'eliminar la capa, eliminem les connexions que la tenen com a entrada o sortida
        modelLayers.forEach(l => {
            if (l.params && l.params.inputs) {
                l.params.inputs = l.params.inputs.filter(id => id !== layerId);
            }
        });
        if (modelLayers[layerIndex].params && modelLayers[layerIndex].params.inputs) {
             modelLayers[layerIndex].params.inputs = []; // Netejar les seves pr貌pies entrades
        }

        modelLayers.splice(layerIndex, 1);
        renderLayers();

        // Select the previous layer
        if (modelLayers.length > 2) {  // If there are more than only input and output
            selectLayer(modelLayers[Math.min(layerIndex, modelLayers.length - 2)].id);
        } else {
            // If there are only input and output, show placeholder
            selectedLayerId = null;
            paramsContainer.innerHTML = `
                <div class="param-placeholder">
                    <div class="hand-pointer">
                        <i class="fas fa-hand-pointer"></i>
                    </div>
                    <h5>Select a layer to configure its parameters.</h5>
                </div>
            `;
        }
        
        // Close the modal
        const removeLayerModal = bootstrap.Modal.getInstance(document.getElementById('removeLayerModal'));
        if (removeLayerModal) {
            removeLayerModal.hide();
        }
        
        showMessage('Layer deleted', 'info');
    }
    
    function clearLayers() {
        const layersContainer = document.getElementById('layers-container');
        
        //  PRESERVAR L'SVG abans d'esborrar
        const svgElement = layersContainer.querySelector('svg');
        layersContainer.innerHTML = '';
        
        //  RESTAURAR L'SVG despr茅s d'esborrar
        if (svgElement) {
            layersContainer.appendChild(svgElement);
        }
        
        // Keep only the input and output layers
        modelLayers = modelLayers.filter(layer => layer.fixed);
        renderLayers();
        
        // Clean selection
        selectedLayerId = null;
        paramsContainer.innerHTML = `
            <div class="param-placeholder">
                <div class="hand-pointer">
                    <i class="fas fa-hand-pointer"></i>
                </div>
                <h5>Select a layer to configure its parameters.</h5>
            </div>
        `;

        showMessage('All custom layers have been deleted', 'info');
    }
    
    function updateLayerParamsForm(layerType) {
        const container = document.getElementById('layer-params-form');
        let paramsHtml = '';
        
        switch (layerType) {
            case 'linear':
                paramsHtml = `
                    <div class="mb-3" id="linear-params">
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="in-features" class="form-label">In Features</label>
                                <input type="number" class="form-control" id="in-features" value="64" min="1">
                            </div>
                            <div class="col-6">
                                <label for="out-features" class="form-label">Out Features</label>
                                <input type="number" class="form-control" id="out-features" value="64" min="1">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="use-bias" checked>
                            <label class="form-check-label" for="use-bias">
                                Use Bias
                            </label>
                        </div>
                    </div>
                `;
                break;
                
            case 'conv1d':
            case 'conv2d':
                const is2d = layerType === 'conv2d';
                paramsHtml = `
                    <div class="mb-3" id="${layerType}-params">
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="in-channels" class="form-label">In Channels</label>
                                <input type="number" class="form-control" id="in-channels" value="1" min="1">
                            </div>
                            <div class="col-6">
                                <label for="out-channels" class="form-label">Out Channels</label>
                                <input type="number" class="form-control" id="out-channels" value="16" min="1">
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col${is2d ? '-6' : ''}">
                                <label for="kernel-size" class="form-label">Kernel Size</label>
                                <input type="number" class="form-control" id="kernel-size" value="3" min="1">
                            </div>
                            ${is2d ? `
                            <div class="col-6">
                                <label for="kernel-size-2" class="form-label">Kernel Size 2</label>
                                <input type="number" class="form-control" id="kernel-size-2" value="3" min="1">
                            </div>
                            ` : ''}
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <label for="stride" class="form-label">Stride</label>
                                <input type="number" class="form-control" id="stride" value="1" min="1">
                            </div>
                            <div class="col-6">
                                <label for="padding" class="form-label">Padding</label>
                                <select class="form-select" id="padding">
                                    <option value="same" selected>same</option>
                                    <option value="valid">valid</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'dropout':
                paramsHtml = `
                    <div class="mb-3" id="dropout-params">
                        <label for="dropout-rate" class="form-label">Dropout Rate</label>
                        <input type="number" class="form-control" id="dropout-rate" value="0.5" min="0" max="1" step="0.1">
                        <div class="form-text">Probabilitat de desactivar neurones durant l'entrenament.</div>
                    </div>
                `;
                break;
                
            case 'batch_norm1d':
            case 'batch_norm2d':
                paramsHtml = `
                    <div class="mb-3" id="${layerType}-params">
                        <div class="row g-2">
                            <div class="col-12">
                                <label for="num-features" class="form-label">Num Features</label>
                                <input type="number" class="form-control" id="num-features" value="64" min="1">
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <label for="eps" class="form-label">Epsilon</label>
                                <input type="number" class="form-control" id="eps" value="0.00001" min="0.00000001" step="0.00000001">
                            </div>
                            <div class="col-6">
                                <label for="momentum" class="form-label">Momentum</label>
                                <input type="number" class="form-control" id="momentum" value="0.1" min="0" max="1" step="0.01">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="affine" checked>
                            <label class="form-check-label" for="affine">
                                Parmetres apresos (affine)
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="track-running-stats" checked>
                            <label class="form-check-label" for="track-running-stats">
                                Track Running Stats
                            </label>
                        </div>
                    </div>
                `;
                break;
                
            case 'maxpool1d':
            case 'maxpool2d':
            case 'avgpool1d':
            case 'avgpool2d':
                const isPool2d = layerType.endsWith('2d');
                paramsHtml = `
                    <div class="mb-3" id="${layerType}-params">
                        <div class="row g-2">
                            <div class="col${isPool2d ? '-6' : ''}">
                                <label for="kernel-size-pool" class="form-label">Kernel Size</label>
                                <input type="number" class="form-control" id="kernel-size-pool" value="2" min="1">
                            </div>
                            
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <label for="stride-pool" class="form-label">Stride</label>
                                <input type="number" class="form-control" id="stride-pool" value="2" min="1">
                            </div>
                            <div class="col-6">
                                <label for="padding-pool" class="form-label">Padding</label>
                                <select class="form-select" id="padding-pool">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'adaptive_avg_pool1d':
                paramsHtml = `
                    <div class="mb-3" id="adaptive_avg_pool1d-params">
                        <div class="row g-2">
                            <div class="col-12">
                                <label for="output-size-adaptive" class="form-label">Output Size</label>
                                <input type="number" class="form-control" id="output-size-adaptive" value="1" min="1">
                                <small class="text-muted">The target output size of the adaptive pooling operation</small>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'activation_relu':
            case 'activation_leakyrelu':
            case 'activation_sigmoid':
            case 'activation_softmax':
            case 'activation_tanh':
                paramsHtml = `
                    <div class="mb-3" id="activation-params">
                        ${layerType === 'activation_leakyrelu' ? `
                        <div class="mb-3">
                            <label for="negative-slope" class="form-label">Negative Slope</label>
                            <input type="number" class="form-control" id="negative-slope" value="0.01" min="0" step="0.01">
                        </div>
                        ` : `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>This activation function has no configurable parameters.
                        </div>
                        `}
                    </div>
                `;
                break;

            case 'lstm':
            case 'gru':
                paramsHtml = `
                    <div class="mb-3" id="${layerType}-params">
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="input-size" class="form-label">Input Size</label>
                                <input type="number" class="form-control" id="input-size" value="64" min="1">
                            </div>
                            <div class="col-6">
                                <label for="hidden-size" class="form-label">Hidden Size</label>
                                <input type="number" class="form-control" id="hidden-size" value="128" min="1">
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-12">
                                <label for="num-layers" class="form-label">Number of Layers</label>
                                <input type="number" class="form-control" id="num-layers" value="1" min="1">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="bidirectional">
                            <label class="form-check-label" for="bidirectional">
                                Bidirectional
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="batch-first" checked>
                            <label class="form-check-label" for="batch-first">
                                Batch First
                            </label>
                        </div>
                    </div>
                `;
                break;
                
            default:
                paramsHtml = `<div class="alert alert-info">Select a layer type.</div>`;
        }
        
        container.innerHTML = paramsHtml;
    }

    // Add the function for the JSON preview view
    function updateJsonPreview() {
        // Create unified structure model configuration
        const modelConfig = {
            metadata: {
                version: "1.0",
                created_at: new Date().toISOString(),
                model_type: "dl",
                framework: document.getElementById('framework').value
            },
            basic_info: {
                name: document.getElementById('model-name').value || 'Model sense nom',
                description: document.getElementById('description').value
            },
            architecture: {
                layers: modelLayers.map(layer => {
                    const { id, fixed, ...cleanParams } = layer;
                    return cleanParams;
                })
            },
            training: {
                optimizer: {
                    type: document.getElementById('optimizer-type').value,
                    learning_rate: parseFloat(document.getElementById('learning-rate').value),
                    weight_decay: parseFloat(document.getElementById('weight-decay').value),
                    differential_privacy: {
                        noise_multiplier: parseFloat(document.getElementById('noise-multiplier').value),
                        max_grad_norm: parseFloat(document.getElementById('max-grad-norm').value),
                        random_seed: parseInt(document.getElementById('dp-seed').value)
                    }
                },
                loss_function: document.getElementById('loss-function').value
            },
            dataset: {
                selected_datasets: {% if selected_datasets %}{{ selected_datasets|default:'[]'|to_json }}{% else %}[]{% endif %}
            }
        };
        
        // Show the formatted JSON in the modal
        document.getElementById('json-preview').textContent = JSON.stringify(modelConfig, null, 2);
    }

    // Check if we come from a dataset
    function checkForDatasetParameter() {
        const urlParams = new URLSearchParams(window.location.search);
        const datasetId = urlParams.get('dataset');
        
        if (datasetId) {
            // Make an AJAX request to get the dataset data
            fetch(`/api/datasets/${datasetId}/info/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Could not retrieve dataset information");
                    }
                    return response.json();
                })
                .then(datasetInfo => {
                    connectarDatasetAlModel(datasetInfo);
                })
                .catch(error => {
                    showMessage(`Error en carregar el dataset: ${error.message}`, 'danger');
                });
        }
    }

    // Function to connect the dataset to the model
    function connectarDatasetAlModel(datasetInfo) {
        // Get input features from features_info
        const inputFeatures = datasetInfo.features_info ? datasetInfo.features_info.input_features : 12;
    
        
        // Configure the input layer
        const inputLayer = modelLayers.find(l => l.id === 'input');
        if (inputLayer) {
            inputLayer.params.features = inputFeatures;
            inputLayer.readonly = true;
        }
        
        // Configure the output layer based on target_info
        let outputFeatures = 1;  // Default for binary classification
        let targetType = 'unknown';

        if (datasetInfo.target_info) {
            targetType = datasetInfo.target_info.type;
            // Use output_neurons from metadata if available, otherwise calculate
            if (datasetInfo.target_info.output_neurons !== undefined && datasetInfo.target_info.output_neurons > 0) {
                outputFeatures = datasetInfo.target_info.output_neurons;
            } else {
                outputFeatures = targetType === 'binary_classification' ? 1 : datasetInfo.target_info.num_classes;
            }
        }
        
        const outputLayer = modelLayers.find(l => l.id === 'output');
        if (outputLayer) {
            outputLayer.params.features = outputFeatures;
            outputLayer.readonly = true;
        }
        
        // Update the interface
        renderLayers();
        
        // Show confirmation message
        showMessage(`Model configured for dataset "${datasetInfo.dataset_name[0]}" with ${inputFeatures} input features and ${outputFeatures} output features (${targetType})`, 'success');
        
        // Show a badge in the configuration panel indicating that the model is connected to a dataset
        addDatasetBadge(datasetInfo.dataset_name[0]);
    }

    // Add a badge indicating that the model is connected to a dataset
    function addDatasetBadge(datasetName) {
        const configForm = document.getElementById('model-config-form');
        
        // Check if the badge already exists
        if (!document.getElementById('dataset-badge')) {
            const badgeHTML = `
                <div id="dataset-badge" class="alert alert-success mb-3">
                    <i class="fas fa-database me-2"></i>Model connected to dataset: <strong>${datasetName}</strong>
                </div>
            `;
            
            configForm.insertAdjacentHTML('afterbegin', badgeHTML);
        }
    }

    // Call the function to check if we come from a dataset
    checkForDatasetParameter();
    
    // Function to get the CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Event listener for the go to training button
    document.getElementById('go-to-training-btn').addEventListener('click', function() {
        const errors = validateModel();
        
        if (errors.length > 0) {
            showValidationErrors(errors);
            return;
        }
        
        // Create unified structure model configuration
        const modelConfig = {
            metadata: {
                version: "1.0",
                created_at: new Date().toISOString(),
                model_type: "dl_linear",
                framework: document.getElementById('framework').value
            },
            basic_info: {
                name: document.getElementById('model-name').value,
                description: document.getElementById('description').value
            },
            architecture: {
                layers: modelLayers.map(layer => {
                    const { id, fixed, ...cleanParams } = layer;
                    return cleanParams;
                })
            },
            training: {
                optimizer: {
                    type: document.getElementById('optimizer-type').value,
                    learning_rate: parseFloat(document.getElementById('learning-rate').value),
                    weight_decay: parseFloat(document.getElementById('weight-decay').value),
                    differential_privacy: {
                        noise_multiplier: parseFloat(document.getElementById('noise-multiplier').value),
                        max_grad_norm: parseFloat(document.getElementById('max-grad-norm').value),
                        random_seed: parseInt(document.getElementById('dp-seed').value)
                    }
                },
                loss_function: document.getElementById('loss-function').value,
                metrics: ["accuracy", "f1_score"],
                epochs: 10,
                batch_size: 32,
                rounds: 10
            },
            dataset: {
                selected_datasets: {% if selected_datasets %}{{ selected_datasets|default:'[]'|to_json }}{% else %}[]{% endif %}
            }
        }
        
        // Show loading message
        showMessage('Saving model...', 'info');
        
        // Save the model and then redirect through go_to_training
        fetch('/api/save-model-config/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: modelConfig.basic_info.name,
                description: modelConfig.basic_info.description,
                model_type: modelConfig.metadata.model_type,
                framework: modelConfig.metadata.framework,
                config: modelConfig
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error in the server response: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                window.location.href = `/go-to-training/${data.model_id}/`;
            } else {
                showMessage('Error saving the model: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            showMessage('Error saving the model: ' + error.message, 'error');
        });
    });

    // Add event listener for the confirmation button in the modal
    document.getElementById('confirm-clear-layers-btn').addEventListener('click', function() {
        modelLayers = modelLayers.filter(layer => layer.fixed);
        
        // Update the view
        renderLayers();
        
        // Close the modal
        const clearLayersModal = bootstrap.Modal.getInstance(document.getElementById('clearLayersModal'));
        clearLayersModal.hide();
        
        // Show confirmation message
        showMessage('All custom layers have been deleted', 'success');
    });

    // Function to validate the model
    function validateModel() {
        const errors = [];
        
        // Verify model name
        const modelName = document.getElementById('model-name').value;
        if (!modelName || modelName.trim() === '') {
            errors.push({
                type: 'error',
                message: 'The model must have a name',
                fix: 'Add a name to the model in the "Model Name" field'
            });
        }
        
        // Verify number of layers
        if (modelLayers.length < 3) {
            errors.push({
                type: 'error',
                message: 'The model needs at least one hidden layer',
                fix: 'Add at least one hidden layer between the input and output layers'
            });
        }
        if (modelLayers.length >= 3) {
        const outputLayer = modelLayers[modelLayers.length - 1]; // Last layer (output)
        const lastHiddenLayer = modelLayers[modelLayers.length - 2]; // Second to last layer
        
        if (lastHiddenLayer.params.features !== outputLayer.params.features) {
            errors.push({
                type: 'error',
                message: `Feature mismatch: Last hidden layer has ${lastHiddenLayer.params.features} features but output layer expects ${outputLayer.params.features} features`,
                fix: `Modify the last hidden layer to have ${outputLayer.params.features} features to match the output layer`
            });
        }
    }
        
        // Verify optimizer configuration
        const learningRate = parseFloat(document.getElementById('learning-rate').value);
        if (isNaN(learningRate) || learningRate <= 0) {
            errors.push({
                type: 'error',
                message: 'Invalid learning rate',
                fix: 'The learning rate must be a positive number'
            });
        }
        
        // Verify that at least one dataset is selected
        const selectedDatasets = {{ selected_datasets|default:'[]'|to_json }};
        if (!selectedDatasets || selectedDatasets.length === 0) {
            errors.push({
                type: 'error',
                message: 'No datasets selected for training',
                fix: 'Go to Datasets section and select at least one dataset before proceeding to training'
            });
        }
        
        return errors;
    }

    // Function to show the errors in the modal
    function showValidationErrors(errors) {
        const errorsList = document.getElementById('validation-errors-list');
        errorsList.innerHTML = errors.map(error => `
            <li class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1 text-danger">
                        <i class="fas fa-times-circle me-2"></i>${error.message}
                    </h6>
                </div>
                <p class="mb-1 text-muted">
                    <i class="fas fa-info-circle me-2"></i>${error.fix}
                </p>
            </li>
        `).join('');
        
        const validationModal = new bootstrap.Modal(document.getElementById('validation-errors-modal'));
        validationModal.show();
    }

    function saveModel() {
        // Verify that the model has a name
        const errors = validateModel();

        if (errors.length > 0) {
            showValidationErrors(errors);
            return;
        }

        const modelName = document.getElementById('model-name').value;
        if (!modelName) {
            showMessage('You must specify a name for the model', 'warning');
            return;
        }
        
        // Create unified structure model configuration
        const modelConfig = {
            metadata: {
                version: "1.0",
                created_at: new Date().toISOString(),
                model_type: "dl",
                framework: document.getElementById('framework').value
            },
            basic_info: {
                name: modelName,
                description: document.getElementById('description').value
            },
            architecture: {
                layers: modelLayers.map(layer => {
                    const { id, fixed, ...cleanParams } = layer;
                    return cleanParams;
                })
            },
            training: {
                optimizer: {
                    type: document.getElementById('optimizer-type').value,
                    learning_rate: parseFloat(document.getElementById('learning-rate').value),
                    weight_decay: parseFloat(document.getElementById('weight-decay').value),
                    differential_privacy: {
                        noise_multiplier: parseFloat(document.getElementById('noise-multiplier').value),
                        max_grad_norm: parseFloat(document.getElementById('max-grad-norm').value),
                        random_seed: parseInt(document.getElementById('dp-seed').value)
                    }
                },
                loss_function: document.getElementById('loss-function').value,
                metrics: ["accuracy", "f1_score"],
                epochs: 100,
                batch_size: 32,
                rounds: 10
            },
            dataset: {
                selected_datasets: {% if selected_datasets %}{{ selected_datasets|default:'[]'|to_json }}{% else %}[]{% endif %}
            }
        };
        
        // Show loading message
        showMessage('Saving the model...', 'info');
        
        fetch('/api/save-model-config/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: modelConfig.basic_info.name,
                description: modelConfig.basic_info.description,
                model_type: modelConfig.metadata.model_type,
                framework: modelConfig.metadata.framework,
                config: modelConfig
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error in the server response');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showMessage(`Model "${modelName}" saved successfully`, 'success');
            } else {
                showMessage('Error saving the model: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error saving the model:', error);
            showMessage('Error saving the model: ' + error.message, 'error');
        });
    }

    // Add this div for the notification banner just after the container-fluid div
    const notificationBanner = document.createElement('div');
    notificationBanner.id = 'notification-banner';
    notificationBanner.className = 'notification-banner';
    notificationBanner.style.display = 'none';
    notificationBanner.innerHTML = `
        <div class="d-flex align-items-center justify-content-start">
            <i class="fas fa-check-circle me-2"></i>
            <span id="notification-message"></span>
        </div>
    `;
    document.body.appendChild(notificationBanner);

    // Use global toast notification system
    function showMessage(message, type = 'success') {
        // Map error type to danger for consistency
        const toastType = type === 'error' ? 'danger' : type;
        showToast(message, toastType);
    }

    // Add this function to the script block
    function loadModelFromConfig(config) {
        try {
            if (!config || typeof config !== 'object') {
                throw new Error('La configuraci贸 no 茅s un objecte vlid');
            }

            // Get layers from unified structure
            let layers = [];
            if (config.architecture && config.architecture.layers) {
                layers = config.architecture.layers;
            }
            
            // Verificar camps requerits
            const requiredFields = ['name', 'framework'];
            const missingFields = requiredFields.filter(field => !(field in config));
            if (missingFields.length > 0) {
                throw new Error(`Falten camps requerits: ${missingFields.join(', ')}`);
            }
            
            // Check if we have layers
            if (!layers || layers.length === 0) {
                throw new Error('The model has no layers in the configuration');
            }
            
            // Carregar configuraci贸 bsica
            const basicFields = {
                'model-name': config.basic_info?.name || '',
                'framework': config.metadata?.framework || 'pytorch',
                'description': config.basic_info?.description || ''
            };

            // Verificar i actualitzar elements amb validaci贸
            for (const [id, value] of Object.entries(basicFields)) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element with ID '${id}' not found, skipping...`);
                    continue;
                }
                if (element.tagName.toLowerCase() === 'select') {
                    // For select elements, check if option exists
                    const option = element.querySelector(`option[value="${value}"]`);
                    if (option) {
                        element.value = value;
                    } else {
                        console.warn(`Option '${value}' not found for select '${id}'`);
                    }
                } else {
                    element.value = value || '';
                }
            }
            
            // Carregar configuraci贸 del optimitzador
            const optimizer = config.training?.optimizer;
            if (optimizer) {
                const optimizerFields = {
                    'optimizer-type': optimizer.type || 'adam',
                    'learning-rate': optimizer.learning_rate || 0.001,
                    'weight-decay': optimizer.weight_decay || 0
                };

                for (const [id, value] of Object.entries(optimizerFields)) {
                    const element = document.getElementById(id);
                    if (!element) {
                        console.warn(`Element optimitzador amb ID '${id}' no trobat, saltant...`);
                        continue;
                    }
                    if (element.tagName.toLowerCase() === 'select') {
                        // For select elements, check if option exists
                        const option = element.querySelector(`option[value="${value}"]`);
                        if (option) {
                            element.value = value;
                        } else {
                            console.warn(`Option '${value}' no trobada per select optimitzador '${id}'`);
                        }
                    } else {
                        element.value = value;
                    }
                }
            }
            
            // Carregar funci贸 de p猫rdua
            const lossElement = document.getElementById('loss-function');
            if (!lossElement) {
                console.warn('Loss function element not found, skipping...');
            } else {
                const lossValue = config.training?.loss_function || 'bce_with_logits';
                const option = lossElement.querySelector(`option[value="${lossValue}"]`);
                if (option) {
                    lossElement.value = lossValue;
                } else {
                    console.warn(`Option '${lossValue}' not found for loss function`);
                }
            }
            
            // Processar capes
            if (!Array.isArray(layers)) {
                throw new Error('The layer configuration is not valid');
            }

            // Obtenir informaci贸 del dataset
            const selectedDatasets = {{ selected_datasets|default:'[]'|to_json }};
            let inputFeatures = 12;
            let outputFeatures = 1;

            if (selectedDatasets && selectedDatasets.length > 0) {
                const dataset = selectedDatasets[0];
                console.log('[DEBUG] Loading model with dataset target_info:', dataset.target_info);

                if (dataset.features_info && dataset.features_info.input_features) {
                    inputFeatures = dataset.features_info.input_features;
                }
                if (dataset.target_info) {
                    // Use output_neurons from metadata if available, otherwise calculate
                    if (dataset.target_info.output_neurons !== undefined && dataset.target_info.output_neurons > 0) {
                        outputFeatures = dataset.target_info.output_neurons;
                    } else {
                        outputFeatures = dataset.target_info.type === 'binary_classification' ? 1 : dataset.target_info.num_classes;
                    }
                }
            }
            
            // Inicialitzar capes base
            modelLayers = [
                {
                    id: 'input',
                    name: 'Input Layer',
                    type: 'input',
                    params: { features: inputFeatures },
                    fixed: true,
                    readonly: true
                },
                {
                    id: 'output',
                    name: 'Output Layer',
                    type: 'output',
                    params: { features: outputFeatures },
                    fixed: true,
                    readonly: true
                }
            ];
            
            // Afegir capes personalitzades
            layers.forEach((layer, index) => {
                if (layer.type !== 'input' && layer.type !== 'output') {
                    const newLayer = {
                        id: 'layer_' + Date.now() + '_' + index,
                        name: layer.name,
                        type: layer.type,
                        category: layer.category || getLayerCategory(layer.type),  // Use existing category or calculate it
                        params: { ...layer.params },
                        fixed: false
                    };
                    modelLayers.splice(modelLayers.length - 1, 0, newLayer);
                }
            });

            renderLayers();
            return true;
        } catch (error) {
            throw new Error(`Error loading the model configuration: ${error.message}`);
        }
    }

    // Function to get the CSRF token if it does not exist
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }   
            }
        }
        return cookieValue;
    }

    function renderLayers() {
        // Separate the buttons and the container of layers
        const layersList = document.createElement('div');
        layersList.className = 'layers-list mb-3';
        layersList.style.overflow = 'auto';
        layersList.style.maxHeight = 'calc(100% - 60px)';  // Reserve space for the buttons
        
        // Render layers
        modelLayers.forEach((layer, index) => {
            // Layer box
            const layerBox = document.createElement('div');
            layerBox.className = `layer-box ${layer.category || layer.type}-layer`;
            layerBox.setAttribute('data-layer-id', layer.id);
            
            // Crear contingut correctament amb DOM
            const layerContent = document.createElement('div');
            layerContent.textContent = getDisplayName(layer);
            const layerFeatures = document.createElement('div');
            layerFeatures.className = 'layer-features';
            layerFeatures.textContent = `Features: ${layer.params.features}`;
            layerBox.appendChild(layerContent);
            layerBox.appendChild(layerFeatures);

            // Click event
            layerBox.addEventListener('click', function() {
                selectLayer(layer.id);
            });
            
            layersList.appendChild(layerBox);
            
            // Connector (except after the last layer)
            if (index < modelLayers.length - 1) {
                const connector = document.createElement('div');
                connector.className = 'layer-connector';
                layersList.appendChild(connector);
            }
        });
        
        // Clean the main container
        const layersContainer = document.getElementById('layers-container');
        layersContainer.innerHTML = '';
        
        // Add the layers list
        layersContainer.appendChild(layersList);
        
        // Add the fixed buttons below
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'text-center mt-3 pt-2 border-top';
        buttonsDiv.style.position = 'sticky';
        buttonsDiv.style.bottom = '0';
        buttonsDiv.style.backgroundColor = '#fff';
        buttonsDiv.innerHTML = `
            <button id="clear-layers-btn" class="btn btn-sm btn-danger">
                <i class="fas fa-trash me-1"></i>Clear Layers
            </button>
        `;
        layersContainer.appendChild(buttonsDiv);
        
        // Re-attach event listeners
        document.getElementById('clear-layers-btn').addEventListener('click', function() {
            // Replace the current confirmation with the opening of the modal
            const clearLayersModal = new bootstrap.Modal(document.getElementById('clearLayersModal'));
            clearLayersModal.show();
        });
    }
    
});

function drawCanvasConnections() {
    const layersPanel = document.getElementById('layers-container');
    if (!layersPanel) {
        return;
    }

    // Eliminar canvas anterior si existeix
    const existingCanvas = layersPanel.querySelector('canvas');
    if (existingCanvas) {
        existingCanvas.remove();
    }

    // Crear canvas dins del contenidor (igual que l'SVG)
    const canvas = document.createElement('canvas');
    canvas.style.position = "absolute";
    canvas.style.top = "0";
    canvas.style.left = "0";
    canvas.style.width = "100%";
    canvas.style.height = "100%";
    canvas.style.pointerEvents = "none";
    canvas.style.zIndex = "1000";
    canvas.style.border = "2px solid blue";
    canvas.style.background = "rgba(0,0,255,0.1)";

    // Ajustar resoluci贸
    const rect = layersPanel.getBoundingClientRect();
    const width = Math.max(rect.width, 800);
    const height = Math.max(rect.height, 600);

    canvas.width = width * window.devicePixelRatio;
    canvas.height = height * window.devicePixelRatio;
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';

    const ctx = canvas.getContext('2d');
    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

    layersPanel.appendChild(canvas);

    // Netejar canvas
    ctx.clearRect(0, 0, width, height);

    // Dibuixar una l铆nia de test primer
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(50, 50);
    ctx.lineTo(250, 250);
    ctx.stroke();

    // Dibuixar connexions reals amb estils espec铆fics segons el tipus
    let connectionsDrawn = 0;
    modelLayers.forEach(targetLayer => {
        if (targetLayer.params?.inputs?.length > 0) {
            // Determinar si 茅s una operaci贸 especial (Add/Concat)
            const isOperationLayer = targetLayer.type === 'operation';
            const operationType = targetLayer.params?.type; // Add, Concat, etc.
            const numInputs = targetLayer.params.inputs.length;

            targetLayer.params.inputs.forEach((sourceId, inputIndex) => {
                const sourceBox = document.querySelector(`.layer-box[data-layer-id="${sourceId}"]`);
                const targetBox = document.querySelector(`.layer-box[data-layer-id="${targetLayer.id}"]`);

                if (sourceBox && targetBox) {
                    const containerRect = layersPanel.getBoundingClientRect();
                    const sourceRect = sourceBox.getBoundingClientRect();
                    const targetRect = targetBox.getBoundingClientRect();

                    const x1 = sourceRect.right - containerRect.left - 6; // Output point
                    const y1 = sourceRect.top + sourceRect.height/2 - containerRect.top;
                    const x2 = targetRect.left - containerRect.left + 6; // Input point
                    const y2 = targetRect.top + targetRect.height/2 - containerRect.top;

                    // Determinar tipus de connexi贸
                    const isSkipConnection = y1 > y2; // Skip connection va "cap enrere" visualment
                    const isLongDistance = Math.abs(x2 - x1) > 300; // Connexi贸 llarga

                    // Configurar estil segons tipus de connexi贸
                    if (isOperationLayer && (operationType === 'Add' || operationType === 'Concat')) {
                        // Estil especial per Add/Concat (U-Net skip connections)
                        if (isSkipConnection) {
                            // Skip connection: l铆nia verda amb curvatura ampla
                            ctx.strokeStyle = '#28a745';
                            ctx.lineWidth = 3;
                            ctx.setLineDash([8, 4]);
                            ctx.globalAlpha = 0.9;
                        } else {
                            // Connexi贸 normal a Add/Concat: blau fort
                            ctx.strokeStyle = '#0056b3';
                            ctx.lineWidth = 3;
                            ctx.setLineDash([]);
                            ctx.globalAlpha = 0.85;
                        }
                    } else {
                        // Connexi贸 estndard
                        ctx.strokeStyle = '#4A90E2';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([5, 5]);
                        ctx.globalAlpha = 0.8;
                    }

                    ctx.lineCap = 'round';

                    // Dibuixar corba amb curvatura adaptada
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);

                    // Calcular curvatura segons tipus de connexi贸
                    let controlOffset;
                    if (isSkipConnection && isOperationLayer) {
                        // Skip connections amb curvatura m茅s pronunciada per U-Net
                        controlOffset = Math.max(Math.abs(x2 - x1) * 0.7, 150);

                        // Punts de control ajustats per skip connections
                        const verticalOffset = Math.abs(y2 - y1) * 0.3;
                        ctx.bezierCurveTo(
                            x1 + controlOffset, y1 - verticalOffset,
                            x2 - controlOffset, y2 + verticalOffset,
                            x2, y2
                        );
                    } else if (isLongDistance || (isOperationLayer && numInputs > 1)) {
                        // Connexions llargues o m煤ltiples entrades: curvatura m茅s suau
                        controlOffset = Math.abs(x2 - x1) * 0.6;

                        // Per m煤ltiples entrades, distribuir verticalment
                        const verticalSpread = numInputs > 1 ? (inputIndex - (numInputs - 1) / 2) * 20 : 0;
                        ctx.bezierCurveTo(
                            x1 + controlOffset, y1 + verticalSpread,
                            x2 - controlOffset, y2 + verticalSpread,
                            x2, y2
                        );
                    } else {
                        // Connexi贸 estndard
                        controlOffset = Math.abs(x2 - x1) * 0.5;
                        ctx.bezierCurveTo(
                            x1 + controlOffset, y1,
                            x2 - controlOffset, y2,
                            x2, y2
                        );
                    }

                    ctx.stroke();
                    connectionsDrawn++;                   
                }
            });
        }
    });
}

// Simplified connections drawing function (replacement for complex _renderConnectionsWithTiming)
</script>
{% endblock %}
